# Solmaalai Server

Node.js server that handles:

- HTTP REST API
- WebSocket multiplayer rooms
- Server-side FST word validation
- SQLite analytics

Runs on a single port (default `8000`).

## Running

```bash
# from repo root
npm install
npm run fst:build   # applies local patches and rebuilds FST artifacts

# server runtime
cd server
npm install
npm start
```

Compatibility wrapper:

```bash
cd server
npm run setup   # invokes root fst/build/build_fsts.py
```

## WebSocket

Connection path:

```text
/{gameId}/{userId}?name={username}
```

Room behavior:

- Room key = `gameId`
- Max 2 players per room
- Broadcast turn/newGame/swap/pass/gameOver/chat events
- Profile sync events: `setProfile` / `playerProfile`
- Request-response validation: `validateWords` -> `validateWordsResult`

## HTTP Endpoints

- `GET /health` - readiness/liveness endpoint
- `POST /api/visit` - analytics page visit
- `POST /api/profile` - upsert player profile (`{ userId, username }`)
- `GET /api/leaderboard?limit=N` - leaderboard ranked by rating
- `POST /api/validate-words` - FST validation via HTTP (`{ words: string[] }`, max 20)
- `POST /api/matchmaking/join` - enter random matchmaking queue
- `GET /api/matchmaking/status?userId=...` - matchmaking status
- `POST /api/matchmaking/cancel` - leave matchmaking queue

## Admin Analytics Endpoints

Set `ANALYTICS_ADMIN_PASSWORD` on the server, then pass it as `X-Admin-Password` header.

- `GET /api/admin/summary` - aggregate analytics + derived stats
- `GET /api/admin/games?limit=N&offset=N&q=...` - paginated/searchable games
- `GET /api/admin/games/:gameId` - game detail with turns + tile-placement data
- `GET /api/admin/players?limit=N&offset=N&q=...` - paginated/searchable players
- `GET /api/admin/players/:userId` - player profile + recent games/turns
- `GET /api/admin/visits/daily?days=N` - daily visit counts
- `GET /api/admin/visits/countries?days=N&limit=N` - visit counts grouped by country
- `GET /api/admin/players/countries?limit=N` - player counts grouped by last-known country

## Notes

- Local development env defaults can be placed in `server/.env` (auto-loaded by `index.js`). Start from `server/.env.example`.
- FST validation is permissive when `flookup`/models are unavailable.
- Set `STRICT_SERVER_VALIDATION=true` to reject unknown words when server-side validation is unavailable.
- Runtime FSTs are read from `server/fst-models/` and are generated by `npm run fst:build`.
- Configure `ALLOWED_ORIGINS` in production for CORS and WebSocket origin checks.
- Geo analytics is controlled by `GEO_PROVIDER=none|ipwhois|ipapi` (default `none`).
- For Railway, configure healthcheck path to `/health`.
- Matchmaking assigns a private `gameId` once two queued users are available.
